---
title: "Exploring Community Resilience Estimates in U.S. Census Data"
author: 
  - "Nathan Alexander, PhD"
  - "Center for Applied Data Science and Analytics"
  - "Howard University"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true  # Enable floating TOC in the sidebar
    number_sections: true
    theme: cerulean
    always_allow_html: true
    self_contained: true
editor_options:
  markdown:
    wrap: sentence
---

# Abstract

I explore the community resilience estimates (CRE) to prepare for future analysis with related variables. The CRE tool was developed by the U.S. Census Bureau to assess the social vulnerability and resilience of neighborhoods across the United States in response to disasters, such as COVID-19, extreme weather events, and economic shocks. It measures the capacity of individuals and households within a community to absorb, endure, and recover from external stresses. The CRE combines granular data from sources like the American Community Survey (ACS) and the Population Estimates Program (PEP) to identify socio-economic vulnerabilities at a detailed geographic level, such as census tracts or counties. 

*In this draft analysis, I explore the relationship between CRE and rent prices in DC.*

```{r setup, include=T, warning=F, results=F, message=F}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(tidycensus)
library(sf)
library(tidyverse)
library(ggplot2)
library(weights)  # weighted correlation
```

# Data

Information on the community resilience esitmates datasets can be found online [here](https://www.census.gov/programs-surveys/community-resilience-estimates/data/datasets.html).

## DC Community Resilience Estimates

Pulling in 2022 CRE data from the census website.

```{r, include=T}
cre.2022.tract <- read.csv("https://www2.census.gov/programs-surveys/demo/datasets/community-resilience/2022/CRE_22_Tract.csv")
str(cre.2022.tract)
```

Adding the state code for Washington, DC.

```{r, include=T}
# CRE data for DC
cre.2022.tract.dc <- cre.2022.tract %>%
  filter(STATE == "11") # FIPS code for DC
```

## DC Rent Prices

Median rent prices.

```{r, include=T, warning=F, message=F}
# median rent data with geometry
dc.median.rent <- get_acs(geography = "tract", 
                variables = "B25105_001", 
                state = "DC", 
                year = 2019, 
                geometry = TRUE)

str(dc.median.rent)
df1 <- dc.median.rent
```

Merging CRE data.

```{r}
# modifying the GEO_ID in df2
df2 <- cre.2022.tract.dc %>%
  mutate(GEOID_modified = str_extract(GEO_ID, "\\d+$")) %>%
  mutate(GEOID_modified = str_sub(GEOID_modified, -11)) %>% 
  relocate(GEOID_modified)

# join data
merged_df <- df1 %>%
  left_join(df2, by = c("GEOID" = "GEOID_modified"))
```

# Analysis

Next, I calculate the correlation between the merged data.

```{r}
# calculating correlation
correlation <- cor(merged_df$estimate, merged_df$PRED3_PE, use = "complete.obs")

# weighted correlation (considering margins of error)
weighted_correlation <- wtd.cor(merged_df$estimate, merged_df$PRED3_PE, 
                                weight = 1 / (merged_df$moe^2 + merged_df$PRED3_PM^2))

print(paste("Pearson correlation:", round(correlation, 3)))
# print(paste("Weighted correlation:", round(weighted_correlation$correlation, 3)))
```

# Visualization

Then I visualize the relationship and check the non-linear relationship.

```{r}
# visualize relationship
ggplot(merged_df, aes(x = estimate, y = PRED3_PE)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", color = "red") +
  labs(title = "Median Rent vs. Community Resilience Estimate",
       x = "Median Rent Estimate",
       y = "% Population with 3+ Risk Factors") +
  theme_minimal()

# examine non-linear relationships
ggplot(merged_df, aes(x = estimate, y = PRED3_PE)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "loess", color = "blue") +
  labs(title = "Median Rent vs. Community Resilience Estimate (Non-linear)",
       x = "Median Rent Estimate",
       y = "% Population with 3+ Risk Factors") +
  theme_minimal()

```

## Black population in DC

```{r}
# I then calculate percent Black population data for DC tracts
dc_black_pop <- get_acs(
  geography = "tract",
  variables = c(
    total_pop = "B03002_001",
    black_pop = "B03002_004"
  ),
  state = "DC",
  year = 2022,
  output = "wide"
)

# Calculate percent Black
dc_black_pop <- dc_black_pop %>%
  mutate(percent_black = (black_popE / total_popE) * 100)

# Now join this with your merged_df
df <- merged_df %>%
  left_join(dc_black_pop %>% select(GEOID, percent_black), by = "GEOID")
```

Plot the median rent against Black population and CRE estimates.

```{r}
ggplot(df, aes(x = estimate)) +
  geom_point(aes(y = PRED3_PE, color = "CRE"), alpha = 0.5) +
  geom_point(aes(y = percent_black, color = "Black"), alpha = 0.5) +
  geom_smooth(aes(y = PRED3_PE, color = "CRE"), method = "lm", se = FALSE) +
  geom_smooth(aes(y = percent_black, color = "Black"), method = "lm", se = FALSE) +
  scale_color_manual(values = c("CRE" = "red", "Black" = "blue")) +
  labs(title = "Median Rent vs. CRE and % Black Population in DC",
       x = "Median Rent Estimate",
       y = "Percentage",
       color = "Variable") +
  theme_minimal()
```

Non-linear relationshp between the variables.

```{r}
ggplot(df, aes(x = estimate)) +
  geom_point(aes(y = PRED3_PE, color = "CRE"), alpha = 0.5) +
  geom_point(aes(y = percent_black, color = "Black"), alpha = 0.5) +
  geom_smooth(aes(y = PRED3_PE, color = "CRE"), method = "loess", se = FALSE) +
  geom_smooth(aes(y = percent_black, color = "% Black"), method = "loess", se = FALSE) +
  scale_color_manual(values = c("CRE" = "red", "Black" = "blue")) +
  labs(title = "Median Rent vs. CRE and % Black Population in DC (Non-linear)",
       x = "Median Rent Estimate",
       y = "Percentage",
       color = "Variable") +
  theme_minimal()


```


```{r, include=F}
# Get population data for DC census tracts
dc_race_data <- get_acs(
  geography = "tract",
  variables = c(
    total = "B03002_001",
    black = "B03002_004"
  ),
  state = "DC",
  year = 2019
)

# Calculate non-Black population
dc_race_data <- dc_race_data %>%
  pivot_wider(names_from = variable, values_from = estimate) %>%
  mutate(non_black = total - black)

str(dc_race_data)
```
